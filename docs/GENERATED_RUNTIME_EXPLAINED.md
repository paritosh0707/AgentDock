# Understanding the "Generated Runtime" in AgentDock

## Quick Answer

**"Generated Runtime"** means that during deployment, AgentDock **creates an actual Python file** by filling in a template with values from your `Dockfile.yaml`. This generated file becomes the FastAPI server that runs your agent.

It's **NOT** filled at runtimeâ€”it's **pre-generated at build time**.

---

## The Two Components

### Component 1: Template (Static, Lives in Repository)
### Component 2: Generated File (Dynamic, Created at Deployment)

---

## Component 1: The Template (What We Store)

**Location:** `packages/sdk-python/agentdock_sdk/deploy.py` (lines 31-79)

This is a **Python f-string template** embedded in the SDK code:

```python
def _render_runtime(spec):
    # This function RETURNS a string of Python code
    # The {curly braces} are f-string placeholders
    return f"""from fastapi import FastAPI, Request, HTTPException
from typing import Dict, Any
import time
from prometheus_client import generate_latest, CONTENT_TYPE_LATEST
from agentdock_common.auth_utils import validate_api_key
from agentdock_adapters.registry import get_adapter
from agentdock_policy.policy_engine import PolicyEngine

app = FastAPI()
SPEC = {json.dumps(spec.model_dump())}  # â† FILLS IN YOUR CONFIG HERE

ADAPTER = get_adapter(SPEC['agent']['framework'])  # â† USES YOUR FRAMEWORK
ADAPTER.load(SPEC['agent']['entrypoint'])  # â† LOADS YOUR AGENT
POLICY = PolicyEngine.from_dockspec(...)  # â† CONFIGURES YOUR POLICIES

@app.get("/health")
async def health():
    return {{"status":"ok"}}

@app.post("/invoke")
async def invoke(req: Request):
    api_key = req.headers.get("X-API-Key")
    validate_api_key(api_key, os.environ.get("AGENTDOCK_API_KEY"))
    payload = await req.json()
    t0 = time.time()
    out = ADAPTER.invoke(payload)  # â† RUNS YOUR AGENT
    dt = time.time() - t0
    return JSONResponse({{"output": out, "latency_s": dt}})
"""
```

**Key Point:** The `{...}` curly braces are f-string placeholders that get filled when `_render_runtime(spec)` is called during deployment!

---

## Component 2: The Generated File (What Gets Created)

### Example Scenario

**Alice's Dockfile.yaml:**
```yaml
version: "1.0"
agent:
  name: invoice-copilot
  entrypoint: examples.invoice_copilot.app.graph:build_graph
  framework: langgraph
model:
  provider: openai
  name: gpt-4o-mini
expose:
  port: 8080
  host: "0.0.0.0"
policies:
  tools:
    allowed: [extract_invoice, summarize_invoice]
    deny_by_default: true
  safety:
    redact_patterns: ["\b\d{16}\b"]
    max_output_chars: 5000
```

### When Alice Runs: `agentdock deploy --target local`

**What Happens in Code:**

```python
# In packages/sdk-python/agentdock_sdk/deploy.py (lines 11-20)

def run_local(dockfile_path: str):
    # 1. Load and parse Alice's Dockfile.yaml
    spec = load_dockspec(dockfile_path)
    # spec.agent.name = "invoice-copilot"
    # spec.agent.framework = "langgraph"
    # spec.agent.entrypoint = "examples.invoice_copilot.app.graph:build_graph"
    
    # 2. Generate the runtime code by filling the template
    code = _render_runtime(spec)  # â† Template is filled here!
    
    # 3. Create directory for generated files
    os.makedirs(".agentdock_runtime", exist_ok=True)
    
    # 4. Write the generated Python code to disk as an actual file
    with open(".agentdock_runtime/main.py", "w") as f:
        f.write(code)  # â† Creates the actual main.py file!
    
    # 5. Install dependencies and run the server
    subprocess.check_call(["python","-m","pip","install","fastapi","uvicorn"])
    return subprocess.Popen(["python","-m","uvicorn","main:app","--host","0.0.0.0","--port","8080"], 
                           cwd=".agentdock_runtime")
```

### The Generated File: `.agentdock_runtime/main.py`

**This is an ACTUAL Python file created on disk:**

```python
# ============================================
# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by: AgentDock SDK
# Source: Dockfile.yaml
# Timestamp: 2024-11-08 10:23:45
# ============================================

from fastapi import FastAPI, Request, HTTPException
from typing import Dict, Any
import time
from prometheus_client import generate_latest, CONTENT_TYPE_LATEST
from agentdock_common.auth_utils import validate_api_key
from agentdock_adapters.registry import get_adapter
from agentdock_policy.policy_engine import PolicyEngine

app = FastAPI()

# ============================================
# CONFIGURATION FROM DOCKFILE.YAML (BAKED IN)
# ============================================
SPEC = {
    "version": "1.0",
    "agent": {
        "name": "invoice-copilot",
        "entrypoint": "examples.invoice_copilot.app.graph:build_graph",
        "framework": "langgraph",
        "description": "Extracts fields from invoices..."
    },
    "model": {
        "provider": "openai",
        "name": "gpt-4o-mini",
        "temperature": 0.2,
        "max_tokens": 1500
    },
    "policies": {
        "tools": {
            "allowed": ["extract_invoice", "summarize_invoice"],
            "deny_by_default": True
        },
        "safety": {
            "redact_patterns": ["\\b\\d{16}\\b"],
            "max_output_chars": 5000,
            "block_prompt_injection": True,
            "halt_on_violation": False
        }
    },
    "expose": {
        "port": 8080,
        "host": "0.0.0.0",
        "rest": True,
        "streaming": "sse"
    },
    "auth": {
        "mode": "api_key",
        "api_keys": {"enabled": True, "rotation_days": 30},
        "roles": [
            {"name": "admin", "permissions": ["deploy", "invoke", "view_metrics"]},
            {"name": "viewer", "permissions": ["invoke"]}
        ],
        "rate_limits": {
            "admin": "1000/m",
            "viewer": "60/m"
        }
    }
    # ... full spec embedded here
}

# ============================================
# INITIALIZE AGENT ADAPTER
# ============================================
# This loads Alice's specific agent using the LangGraph adapter
ADAPTER = get_adapter(SPEC['agent']['framework'])  # Returns LangGraphAdapter
ADAPTER.load(SPEC['agent']['entrypoint'])  # Loads: examples.invoice_copilot.app.graph:build_graph

# ============================================
# INITIALIZE POLICY ENGINE
# ============================================
# This configures safety policies from the Dockfile
POLICY = PolicyEngine.from_dockspec(type("X",(object,), {
    "policies": type("Y",(object,), {
        "tools": type("T",(object,), {
            "allowed": ["extract_invoice", "summarize_invoice"],
            "deny_by_default": True
        })(),
        "safety": type("S",(object,), {
            "redact_patterns": ["\\b\\d{16}\\b"],
            "max_output_chars": 5000,
            "block_prompt_injection": True,
            "halt_on_violation": False
        })()
    })()
})())

# ============================================
# API ENDPOINTS
# ============================================

@app.get("/health")
async def health():
    """Health check endpoint"""
    return {"status": "ok"}

@app.get("/schema")
async def schema():
    """Return the I/O schema for this agent"""
    return SPEC.get("io_schema", {})

@app.get("/metrics")
async def metrics():
    """Prometheus metrics endpoint"""
    data = generate_latest()
    return Response(content=data, media_type=CONTENT_TYPE_LATEST)

from fastapi.responses import JSONResponse, Response

@app.post("/invoke")
async def invoke(req: Request):
    """Main invocation endpoint - runs Alice's agent"""
    
    # 1. Validate API key
    api_key = req.headers.get("X-API-Key")
    validate_api_key(api_key, os.environ.get("AGENTDOCK_API_KEY"))
    
    # 2. Get input payload
    payload = await req.json()
    
    # 3. Invoke Alice's agent
    t0 = time.time()
    out = ADAPTER.invoke(payload)
    
    # 4. Apply safety policies (redact sensitive data, enforce max length)
    if isinstance(out, dict) and "notes" in out and isinstance(out["notes"], str):
        out["notes"] = POLICY.post_invoke(out["notes"])
    
    # 5. Calculate latency
    dt = time.time() - t0
    
    # 6. Return response
    return JSONResponse({"output": out, "latency_s": dt})
```

**This is a REAL file!** Alice can:
- âœ… Read it: `cat .agentdock_runtime/main.py`
- âœ… Edit it (for debugging, though regeneration will overwrite)
- âœ… Run it directly: `python -m uvicorn main:app`
- âœ… Set breakpoints in it with a debugger

---

## Visual Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DEVELOPER CREATES CONFIG                                  â”‚
â”‚                                                               â”‚
â”‚    Dockfile.yaml (Human-written YAML)                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚    â”‚ version: "1.0"            â”‚                             â”‚
â”‚    â”‚ agent:                    â”‚                             â”‚
â”‚    â”‚   name: invoice-copilot   â”‚                             â”‚
â”‚    â”‚   framework: langgraph    â”‚                             â”‚
â”‚    â”‚   entrypoint: my.app:fn   â”‚                             â”‚
â”‚    â”‚ expose:                   â”‚                             â”‚
â”‚    â”‚   port: 8080              â”‚                             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ $ agentdock deploy --target local
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SDK READS AND PARSES                                      â”‚
â”‚                                                               â”‚
â”‚    packages/sdk-python/agentdock_sdk/client.py              â”‚
â”‚                                                               â”‚
â”‚    spec = load_dockspec("Dockfile.yaml")                     â”‚
â”‚    # Returns DockSpec object with all fields                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SDK FILLS TEMPLATE                                        â”‚
â”‚                                                               â”‚
â”‚    packages/sdk-python/agentdock_sdk/deploy.py              â”‚
â”‚                                                               â”‚
â”‚    Template (f-string with placeholders):                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ def _render_runtime(spec):         â”‚                   â”‚
â”‚    â”‚   return f"""                      â”‚                   â”‚
â”‚    â”‚   SPEC = {json.dumps(spec)}  â† PLACEHOLDERâ”‚            â”‚
â”‚    â”‚   ADAPTER = get_adapter(           â”‚                   â”‚
â”‚    â”‚     SPEC['agent']['framework']     â”‚                   â”‚
â”‚    â”‚   )  â† USES spec.agent.framework   â”‚                   â”‚
â”‚    â”‚   """                               â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                       â”‚                                       â”‚
â”‚                       â”‚ Python evaluates f-string            â”‚
â”‚                       â–¼                                       â”‚
â”‚    Generated String (Python code as text):                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ SPEC = {                            â”‚                   â”‚
â”‚    â”‚   "agent": {                        â”‚                   â”‚
â”‚    â”‚     "name": "invoice-copilot",     â”‚                   â”‚
â”‚    â”‚     "framework": "langgraph"       â”‚                   â”‚
â”‚    â”‚   }                                 â”‚                   â”‚
â”‚    â”‚ }                                   â”‚                   â”‚
â”‚    â”‚ ADAPTER = get_adapter("langgraph") â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SDK WRITES FILE TO DISK                                   â”‚
â”‚                                                               â”‚
â”‚    with open(".agentdock_runtime/main.py", "w") as f:       â”‚
â”‚        f.write(code)                                         â”‚
â”‚                                                               â”‚
â”‚    Filesystem now contains:                                  â”‚
â”‚    .agentdock_runtime/                                       â”‚
â”‚    â””â”€â”€ main.py  â† THE GENERATED FILE (real Python file!)    â”‚
â”‚                                                               â”‚
â”‚    This file contains 100+ lines of working Python code      â”‚
â”‚    with all configuration values baked in!                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SDK BUILDS DOCKER IMAGE                                   â”‚
â”‚                                                               â”‚
â”‚    Also generates Dockerfile:                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚    â”‚ FROM python:3.11-slim             â”‚                     â”‚
â”‚    â”‚ RUN pip install fastapi uvicorn   â”‚                     â”‚
â”‚    â”‚ COPY .agentdock_runtime /app      â”‚  â† Copies main.py  â”‚
â”‚    â”‚ COPY examples /app/examples       â”‚  â† User's agent    â”‚
â”‚    â”‚ EXPOSE 8080                       â”‚                     â”‚
â”‚    â”‚ CMD ["uvicorn", "main:app",       â”‚                     â”‚
â”‚    â”‚      "--host", "0.0.0.0",         â”‚                     â”‚
â”‚    â”‚      "--port", "8080"]            â”‚                     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                               â”‚
â”‚    $ docker build -t agentdock/invoice-copilot:latest .     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DOCKER IMAGE CONTENTS                                     â”‚
â”‚                                                               â”‚
â”‚    agentdock/invoice-copilot:latest                          â”‚
â”‚    â”œâ”€â”€ /app/main.py              â† Generated runtime         â”‚
â”‚    â”œâ”€â”€ /app/examples/            â† Alice's agent code        â”‚
â”‚    â”‚   â””â”€â”€ invoice_copilot/                                  â”‚
â”‚    â”‚       â””â”€â”€ app/                                          â”‚
â”‚    â”‚           â””â”€â”€ graph.py                                  â”‚
â”‚    â””â”€â”€ /usr/local/lib/python3.11/site-packages/             â”‚
â”‚        â”œâ”€â”€ fastapi/                                          â”‚
â”‚        â”œâ”€â”€ uvicorn/                                          â”‚
â”‚        â”œâ”€â”€ agentdock_adapters/    â† AgentDock packages       â”‚
â”‚        â”œâ”€â”€ agentdock_policy/                                 â”‚
â”‚        â”œâ”€â”€ agentdock_telemetry/                              â”‚
â”‚        â”œâ”€â”€ agentdock_common/                                 â”‚
â”‚        â””â”€â”€ langgraph/             â† Agent framework          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. CONTAINER RUNS                                            â”‚
â”‚                                                               â”‚
â”‚    $ docker run -p 8080:8080 \                               â”‚
â”‚        -e OPENAI_API_KEY=sk-... \                            â”‚
â”‚        -e AGENTDOCK_API_KEY=agd_... \                        â”‚
â”‚        agentdock/invoice-copilot:latest                      â”‚
â”‚                                                               â”‚
â”‚    Inside container:                                         â”‚
â”‚    $ cd /app                                                 â”‚
â”‚    $ uvicorn main:app --host 0.0.0.0 --port 8080            â”‚
â”‚                                                               â”‚
â”‚    The generated main.py starts:                             â”‚
â”‚    - FastAPI server initializes                              â”‚
â”‚    - Loads adapter: LangGraphAdapter                         â”‚
â”‚    - Imports Alice's agent: build_graph()                    â”‚
â”‚    - Configures policies                                     â”‚
â”‚    - Starts listening on http://0.0.0.0:8080                â”‚
â”‚                                                               â”‚
â”‚    âœ… Server ready to accept requests!                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Why Generate Instead of Using a Generic Runtime?

### âŒ Alternative Approach: Generic Runtime (What we DON'T do)

```python
# runtime.py - One generic file for all agents
import yaml

# Load config at RUNTIME
with open("/app/Dockfile.yaml") as f:
    spec = yaml.safe_load(f)

# Dynamically get adapter
adapter = get_adapter(spec["agent"]["framework"])
adapter.load(spec["agent"]["entrypoint"])

@app.post("/invoke")
async def invoke(req: Request):
    # Runtime lookup
    out = adapter.invoke(await req.json())
    return {"output": out}
```

**Problems:**
- âŒ **Slower startup**: Reads and parses YAML every time container starts
- âŒ **External dependency**: Requires Dockfile.yaml to be mounted in container
- âŒ **Harder to debug**: Config is separate, can't see what agent will use
- âŒ **Runtime errors**: Configuration errors only discovered when starting
- âŒ **Not immutable**: Config could change if file is modified
- âŒ **Extra dependencies**: Needs YAML parser in runtime

### âœ… Our Approach: Generated Runtime (What we DO)

```python
# main.py - Generated specifically for invoice-copilot agent
SPEC = {
    "agent": {
        "framework": "langgraph",
        "entrypoint": "examples.invoice_copilot.app.graph:build_graph"
    }
    # ... all config baked in
}

# Direct initialization (no lookup)
adapter = get_adapter("langgraph")
adapter.load("examples.invoice_copilot.app.graph:build_graph")

@app.post("/invoke")
async def invoke(req: Request):
    out = adapter.invoke(await req.json())
    return {"output": out}
```

**Benefits:**
- âœ… **Faster startup**: Config is already Python (no parsing)
- âœ… **Self-contained**: No external files needed
- âœ… **Easy to debug**: Just read main.py to see exact configuration
- âœ… **Build-time validation**: Errors caught during deployment, not at runtime
- âœ… **Immutable**: Config can't change after image is built
- âœ… **Fewer dependencies**: No YAML parser needed in runtime
- âœ… **Optimizable**: Can generate agent-specific optimizations

---

## Real Developer Experience

### After Deployment, Alice Can Inspect the Generated File:

```bash
$ agentdock deploy --target local
âœ… Deployment successful!
ğŸ“¦ Generated runtime at: .agentdock_runtime/main.py

$ ls -lh .agentdock_runtime/
total 8.0K
-rw-r--r-- 1 alice alice 3.4K Nov  8 10:23 main.py

$ cat .agentdock_runtime/main.py
# She can read the entire generated code!
# It's readable Python with all her config visible

$ wc -l .agentdock_runtime/main.py
134 .agentdock_runtime/main.py
```

### Alice Can Even Run It Directly for Debugging:

```bash
$ cd .agentdock_runtime

# Install dependencies
$ pip install -r ../requirements.txt

# Run the server directly (not in Docker)
$ uvicorn main:app --reload
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete.

# In another terminal, test it
$ curl -X POST http://localhost:8000/invoke \
  -H "X-API-Key: test-key" \
  -H "Content-Type: application/json" \
  -d '{"document_text": "INVOICE #123..."}'
```

### Alice Can Set Breakpoints in the Generated File:

```python
# In .agentdock_runtime/main.py
@app.post("/invoke")
async def invoke(req: Request):
    import pdb; pdb.set_trace()  # â† Alice adds breakpoint
    payload = await req.json()
    out = ADAPTER.invoke(payload)
    return JSONResponse({"output": out})
```

Then run with debugger:
```bash
$ python -m pdb -m uvicorn main:app
```

---

## Template vs Generated: Side-by-Side Comparison

| Aspect | Template | Generated File |
|--------|----------|----------------|
| **Location** | `packages/sdk-python/agentdock_sdk/deploy.py` | `.agentdock_runtime/main.py` |
| **Type** | Python f-string (code that generates code) | Actual Python file |
| **Contains** | Placeholders like `{spec.agent.name}` | Real values like `"invoice-copilot"` |
| **When Created** | Written once by AgentDock developers | Created each time you deploy |
| **For Whom** | All users (generic template) | Your specific agent |
| **Can Execute?** | No (it's a string template) | Yes (it's valid, runnable Python) |
| **In Git?** | Yes (committed to repo) | No (in `.gitignore`, regenerated) |
| **In Docker?** | No | Yes (copied into image) |
| **Line Count** | ~50 lines (template logic) | ~130 lines (full runtime) |
| **Editable?** | By AgentDock devs only | You can edit for debugging |
| **Changes When** | Template is updated | You change Dockfile and redeploy |

---

## The Magic: How Template Rendering Works

### Python f-string Evaluation

```python
# In deploy.py
def _render_runtime(spec):
    # spec.agent.name = "invoice-copilot"
    # spec.agent.framework = "langgraph"
    
    # This f-string is evaluated RIGHT NOW (at deploy time)
    code = f"""
    SPEC = {json.dumps(spec.model_dump())}
    ADAPTER = get_adapter('{spec.agent.framework}')
    """
    
    # After f-string evaluation, code contains:
    # 
    # SPEC = {"agent": {"name": "invoice-copilot", "framework": "langgraph", ...}}
    # ADAPTER = get_adapter('langgraph')
    
    return code  # Returns actual Python code as a string
```

**Key Insight:** 
- The template uses Python's f-string feature
- **When:** F-string is evaluated at deployment time (when `_render_runtime()` is called)
- **Result:** A string containing valid Python code with all values filled in
- **Then:** This string is written to disk as `main.py`

---

## Analogy: Like a Form Letter (Mail Merge)

### 1. Template (Form Letter)
```
Dear {customer_name},

Your order {order_id} for {product_name} has shipped!
Thank you for your purchase.

Sincerely,
{company_name}
```

### 2. Data
```python
customer_name = "Alice"
order_id = "12345"
product_name = "Widget"
company_name = "AgentDock Inc."
```

### 3. Generated Letter (Actual Document)
```
Dear Alice,

Your order 12345 for Widget has shipped!
Thank you for your purchase.

Sincerely,
AgentDock Inc.
```

**The generated letter:**
- âœ… Is a real document that exists on paper (or in a file)
- âœ… Can be read by anyone
- âœ… Is specific to Alice (not generic)
- âœ… Doesn't change after it's printed
- âœ… Doesn't need the template to exist

**Same with generated runtime:**
- âœ… Is a real Python file that exists on disk
- âœ… Can be read and debugged
- âœ… Is specific to your agent (not generic)
- âœ… Doesn't change after Docker image is built
- âœ… Doesn't need the template to run

---

## Common Questions

### Q: What if I change my Dockfile.yaml after deploying?

**A:** The generated `main.py` won't change automatically. You need to redeploy:

```bash
$ agentdock deploy  # Regenerates main.py with new config
```

The old generated file is overwritten.

---

### Q: Can I edit the generated main.py directly?

**A:** Yes, you can edit it for debugging, but:
- âš ï¸ Changes will be lost on next deployment (file is regenerated)
- âš ï¸ Changes won't be in the Docker image if you already built it
- âœ… Good for quick testing/debugging
- âœ… Better to update Dockfile.yaml and redeploy for permanent changes

---

### Q: Is the generated file checked into Git?

**A:** No, it should be in `.gitignore`:

```gitignore
# .gitignore
.agentdock_runtime/
```

**Why?** It's generated from Dockfile.yaml, so only the source (Dockfile) needs version control.

---

### Q: What happens if template rendering fails?

**A:** You get an error during deployment, before Docker image is built:

```bash
$ agentdock deploy
âŒ Error generating runtime:
   Invalid entrypoint format: 'missing_colon'
   Expected: 'module:callable'
```

This is better than runtime errors! Errors are caught early.

---

### Q: Can I use my own template?

**A:** In V1, noâ€”the template is built into the SDK. In future versions, we might support custom templates for advanced use cases.

---

## Summary

| Question | Answer |
|----------|--------|
| **What is the generated runtime?** | A Python file (`main.py`) created by filling in a template with your Dockfile values |
| **When is it generated?** | During `agentdock deploy` command, before Docker build |
| **Where does it live?** | `.agentdock_runtime/main.py` (local) and `/app/main.py` (in Docker image) |
| **Can I see it?** | Yes! It's a real file you can read, inspect, and debug |
| **Does it change?** | Only when you redeploy; it's immutable once Docker image is built |
| **Why generate it?** | Faster, self-contained, easier to debug than reading config at runtime |
| **Template vs Generated?** | Template has placeholders (`{spec.name}`), generated has values (`"invoice-copilot"`) |
| **Is it checked into Git?** | No, it's generated (like compiled code), only source (Dockfile) is versioned |

---

## Key Takeaway

**"Generated Runtime" = Build-Time Code Generation**

We **generate code at build time** (deployment), not read config at run time. This makes the runtime:
- âœ… Faster (no parsing)
- âœ… Self-contained (no external files)
- âœ… Debuggable (just read the file)
- âœ… Immutable (can't change after build)
- âœ… Validated early (errors caught during deployment)

It's like compiling: source code (Dockfile.yaml) â†’ generated code (main.py) â†’ executable (Docker image).

