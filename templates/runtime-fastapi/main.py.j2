"""
Dockrion Generated Runtime
==========================
Agent: {{ agent.name }}
{%- if agent.handler %}
Mode: Handler (direct callable)
Handler: {{ agent.handler }}
{%- else %}
Mode: Entrypoint (framework agent)
Framework: {{ agent.framework }}
Entrypoint: {{ agent.entrypoint }}
{%- endif %}
Description: {{ agent.description | default('Dockrion Agent', true) }}

Auto-generated by Dockrion SDK v{{ dockrion_version | default('1.0.0') }}
Do not edit manually - regenerate using `dockrion build`
"""
import sys
from pathlib import Path

# Add project root to Python path for agent module imports
# We need to find the directory that contains the agent's top-level module
current_dir = Path(__file__).parent
project_root = current_dir.parent

# For handlers/entrypoints in nested directories (e.g., examples/agent_name/),
# we need to find the actual project root by looking for the top-level module
{% if agent.handler -%}
handler_module = "{{ agent.handler }}".split(":")[0]
{% else -%}
handler_module = "{{ agent.entrypoint }}".split(":")[0]
{% endif -%}
top_level_module = handler_module.split(".")[0]

# Walk up the directory tree to find where the top-level module exists
max_levels = 5  # Safety limit to prevent infinite loops
for _ in range(max_levels):
    if (project_root / top_level_module).exists():
        break
    if project_root.parent == project_root:  # Reached filesystem root
        break
    project_root = project_root.parent

if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from dockrion_runtime import create_app
from dockrion_schema import DockSpec

# ============================================================================
# Agent Specification (Embedded from Dockfile.yaml)
# ============================================================================

SPEC_DATA = {{ spec_python }}

# ============================================================================
# Create Application
# ============================================================================

# Parse and validate the embedded specification
spec = DockSpec.model_validate(SPEC_DATA)

# Create the FastAPI application using the runtime factory
{%- if agent.handler %}
# Handler mode: direct callable function
app = create_app(
    spec=spec,
    agent_handler="{{ agent.handler }}"
)
{%- else %}
# Entrypoint mode: framework agent
app = create_app(
    spec=spec,
    agent_entrypoint="{{ agent.entrypoint }}"
)
{%- endif %}

# ============================================================================
# Main Entry Point
# ============================================================================

if __name__ == "__main__":
    import uvicorn
    
    host = "{{ expose.host | default('0.0.0.0') if expose else '0.0.0.0' }}"
    port = {{ expose.port | default(8080) if expose else 8080 }}
    
    print(f"ðŸš€ Starting {{ agent.name }} on {host}:{port}")
    uvicorn.run(
        app,
        host=host,
        port=port,
        log_level="info"
    )
